# OverlayLex 协作记录

## 目的
- 记录本仓库中由代理执行的关键改动，方便初学者回溯与学习。

## 约定
- 每次完成一批可运行的改动后立即提交。
- 提交信息推荐采用 Conventional Commits 风格。

## 变更日志
- 2026-02-08
  - 新增 `src/tools/overlaylex-i18n-flow.mjs`：实现 OverlayLex i18n 一体化流程脚本，支持 `merge-collected`、`to-paratranz`、`from-paratranz`、`pull-paratranz`、`push-paratranz`、`bump-release-version` 六个子命令。
  - 新增 `config/overlaylex-i18n.config.json`：补充流程脚本默认配置（包目录、临时目录、Paratranz 基础地址/项目ID/路径前缀、合并策略与导入策略）。
  - 更新 `src/userscript/overlaylex.collector.user.js`：采集导出格式从“按域名文本串”改为“按域名分组 JSON 对象”（`{ host: [texts...] }`），并同步复制成功提示文案与脚本版本到 `0.1.1`。
- 2026-02-07
  - 更新 `src/userscript/overlaylex.user.js`：按反馈将悬浮球从 `11px` 调整为 `22px`（翻倍），并按比例同步图标、呼吸圈与状态点参数，兼顾可见性与遮挡控制。
  - 更新 `src/userscript/overlaylex.user.js`：新增“点击面板外区域自动收起为悬浮球”逻辑（捕获阶段监听 `pointerdown`），提升收起交互直觉性。
  - 更新 `src/userscript/overlaylex.user.js`：翻译包列表右侧状态图标改为“常态不显示，只有手动更新过程中下载该包时显示云下载图标”，移除常态对勾展示。
  - 更新 `src/userscript/overlaylex.user.js`：版本升级至 `0.2.8`。
  - 更新 `src/userscript/overlaylex.user.js`：按用户要求将悬浮球缩减到上一版约 `1/4` 尺寸（`44px -> 11px`），并同步缩小图标、呼吸圈与状态点参数。
  - 更新 `src/userscript/overlaylex.user.js`：版本升级至 `0.2.7`。
  - 更新 `src/userscript/overlaylex.user.js`：悬浮球默认尺寸由 `56px` 缩小到 `44px`，并同步缩小图标、呼吸圈与状态点，降低遮挡感。
  - 更新 `src/userscript/overlaylex.user.js`：新增 `UI_TUNING.floatingBall` 集中配置（`sizePx/iconPx/ringInsetPx/ringBlurPx/dotSizePx/dotOffsetPx`），支持初学者在单一位置手动微调悬浮球视觉尺寸。
  - 更新 `src/userscript/overlaylex.user.js`：版本升级至 `0.2.6`。
  - 更新 `src/userscript/overlaylex.user.js`：将 `translate/language/settings/cloud_sync` 四个手绘图标替换为用户提供的官方 Material Symbols SVG 路径，修复图形风格不一致问题；同时把图标填充色统一为 `currentColor` 以复用亮暗主题配色。
  - 更新 `src/userscript/overlaylex.user.js`：版本升级至 `0.2.5`，用于区分“官方 SVG 图标替换”修复版本。
  - 更新 `src/userscript/overlaylex.user.js`：移除外部字体图标依赖，统一改为内置 SVG 图标渲染，修复 `translate/settings/cloud_sync/close/done/cloud_download` 在部分站点显示为英文文本的问题。
  - 更新 `src/userscript/overlaylex.user.js`：重写浮窗显隐控制为 `overlaylex-hidden` 类，规避宿主站样式覆盖 `hidden` 属性导致的“关闭按钮无响应/面板无法收起”问题。
  - 更新 `src/userscript/overlaylex.user.js`：拖拽事件改为 `mousedown/touchstart` 双通道，修复部分设备与页面环境下“显示可拖动手型但实际拖不动”的问题，并保持面板与悬浮球位置一体化。
  - 更新 `src/userscript/overlaylex.user.js`：悬浮球升级为玻璃态气泡样式，新增轻微呼吸光环与“长按 650ms 触发重注入”交互。
  - 更新 `AGENTS.md`：补充本次 `paratranz-api` skill 提交记录，确保协作日志与仓库提交保持一致。
  - 新增 `skills/paratranz-api/SKILL.md`：创建 ParaTranz API 交互技能，明确触发条件、标准工作流、错误处理和最小可运行示例。
  - 新增 `skills/paratranz-api/agents/openai.yaml`：补充技能 UI 元信息与默认提示词，便于在 Codex 技能列表中触发。
  - 新增 `skills/paratranz-api/scripts/paratranz-api-client.mjs`：实现通用 API CLI（按 operationId 调用、支持 path/query/header/json/form/raw-body、dry-run 与输出落盘）。
  - 新增 `skills/paratranz-api/references/api-docs.yml`：收录 ParaTranz OpenAPI 原始文档副本，保证技能自包含。
  - 新增 `skills/paratranz-api/references/operation-index.json`：从 OpenAPI 自动抽取 48 个接口的机器可读索引，避免遗漏调用方式。
  - 新增 `skills/paratranz-api/references/endpoints.md`：生成逐接口教学向参考文档，覆盖每个 operationId 的参数、请求体与最小调用示例。
  - 更新 `src/userscript/overlaylex.user.js`：补齐 Material 图标体系（翻译、设置、更新、关闭、下载/状态图标），修复图标缺失与样式不一致问题。
  - 更新 `src/userscript/overlaylex.user.js`：修复包开关样式层级，恢复“开启后仍保留白色圆点滑块”的正常开关动画表现。
  - 更新 `src/userscript/overlaylex.user.js`：新增面板顶部拖动条拖拽能力，并将悬浮球与面板绑定为同一位置锚点；展开面板时隐藏悬浮球，关闭面板时恢复到同位置。
  - 更新 `src/userscript/overlaylex.user.js`：版本升级至 `0.2.3`。
  - 更新 `src/userscript/overlaylex.user.js`：重构主控制台 UI 为新玻璃态浮窗风格（亮色/暗色双主题），新增“明亮/暗夜/跟随系统”主题设置与系统主题联动监听，同时保持包列表、按钮、状态文本等业务内容动态渲染，不再使用示例写死文案。
  - 更新 `src/userscript/overlaylex.user.js`：保留并强化“域名门禁优先”启动顺序，确保仅在命中域名包白名单后才注入悬浮球与控制面板，未命中域名直接退出。
  - 合并 `src/packages/obr-room-core.json` 与 `src/packages/obr-www-owlbear-rodeo.json`：统一保留 `obr-www-owlbear-rodeo`，并合并词条。
  - 更新 `src/packages/obr-www-owlbear-rodeo.json`：升级为主站与房间共用包，`target` 改为 `hosts` 双域名匹配，版本升至 `0.2.0`。
  - 删除 `src/packages/obr-room-core.json`：移除重复翻译包，避免同站点重复加载与冲突覆盖。
  - 更新 `src/worker/src/data.js`：下线 `obr-room-core` 目录项，提升 `obr-www-owlbear-rodeo` 目录版本到 `0.2.0`，并新增 `obr-room-core` 内置兼容别名回退，避免旧缓存 manifest 404。
  - 更新 `src/userscript/overlaylex.user.js`：`isPackageTargetMatched` 新增 `target.hosts` 多域名匹配支持，并将冷启动回退包改为 `obr-www-owlbear-rodeo`。
  - 更新 `src/worker/src/index.js`：修正包路由示例注释为新包 ID。
  - 更新 `README.md`：移除 `obr-room-core` 说明，统一示例到 `obr-www-owlbear-rodeo`。
- 2026-02-06
  - 新增 `src/userscript/overlaylex.user.js`：实现 OverlayLex 用户脚本首版（缓存、包加载、增量翻译、悬浮面板、手动更新）。
  - 新增 `src/worker/src/data.js`：实现 Worker 侧翻译包注册表与 manifest 生成函数。
  - 新增 `src/worker/src/index.js`：实现 Worker API 路由与 CORS 响应封装。
  - 新增 `src/worker/package.json` 与 `src/worker/wrangler.toml`：补齐 Worker 本地开发与部署配置。
  - 新增 `src/packages/obr-room-core.json`：提供房间页第一版示例翻译包。
  - 新增 `src/tools/extract-visible-texts.js`：提供 HTML 候选文本抽取工具，用于快速建词典。
  - 新增 `README.md`：补充最小可运行步骤、API 说明与抽词翻译工作流。
  - 新增 `src/packages/overlaylex-domain-allowlist.json`：补充域名准入包，用于全站触发后的快速放行判断。
  - 更新 `src/worker/src/data.js`：升级 manifest 为“翻译包 + 域名包”，并添加 R2 失败时内置回退包。
  - 更新 `src/worker/src/index.js`：新增 `/packages`、`/domain-package.json`，并改为优先从 R2 读取包正文。
  - 更新 `src/worker/wrangler.toml`：绑定 R2 桶 `PACKAGES_BUCKET`。
  - 重写 `src/userscript/overlaylex.user.js`：实现全站 match、域名包门禁、iframe 补充翻译、顶层独立控制台与新版 manifest 适配。
  - 更新 `src/userscript/overlaylex.user.js`：回填已部署 Worker 地址 `overlaylex-demo-api.zhangjiahe0830.workers.dev`。
  - 更新 `README.md`：补充线上 API 地址、R2 桶信息、新增接口与运行策略说明。
  - 更新 `src/packages/obr-room-core.json`：纳入用户手动翻译修订（`Owlbear Rodeo -> 枭熊VTT`）。
  - 更新 `.gitignore`：忽略 `src/worker/node_modules/` 与 `src/worker/.wrangler/`。
  - 云端部署：Worker `overlaylex-demo-api` 已发布到 `https://overlaylex-demo-api.zhangjiahe0830.workers.dev`，R2 桶 `overlaylex-packages-bfdcb419` 已绑定并上传两个包对象。
  - 远程验证：`/health`、`/manifest`、`/packages`、`/packages/obr-room-core.json`、`/packages/overlaylex-domain-allowlist.json`、`/domain-package.json` 均可返回有效数据。
  - 更新 `src/userscript/overlaylex.user.js`：新增本地种子域名冷启动门禁、缓存优先拒绝策略、运行期自动采集器（按域名分层、跨会话去重、增量复制、iframe 域名记录）。
  - 新增 `src/packages/overlaylex-domain-seeds.json`：仓库内维护种子域名规则说明。
  - 删除 `src/tools/extract-visible-texts.js`：废弃静态 HTML 抽词流程，改为用户脚本实时采集。
  - 更新 `README.md`：抽词流程改为“运行期自动采集器”使用说明。
  - 回退 `src/userscript/overlaylex.user.js`：移除采集逻辑，恢复主脚本“仅负责翻译注入”的单一职责。
  - 新增 `src/userscript/overlaylex.collector.user.js`：独立实时采集脚本（全站运行、按域名去重、增量复制、iframe 域名记录）。
  - 更新 `README.md`：改为双脚本说明，明确“主翻译脚本”与“独立采集脚本”分离安装与使用流程。
  - 更新 `src/userscript/overlaylex.collector.user.js`：采集脚本悬浮球支持拖动，并避免拖拽后误触发点击开关面板。
  - 更新 `src/userscript/overlaylex.collector.user.js`：采集仅保留“纯英文向”词条（过滤中文/无字母噪声），并排除采集器自身 UI 文案，修复计数自循环增长问题。
  - 更新 `src/userscript/overlaylex.collector.user.js`：复制导出改为简洁行格式 `"英文",""`，新增“一键复制全部合并”按钮（跨域名去重合并导出）。
  - 更新 `src/userscript/overlaylex.collector.user.js`：新增“清空当前域数据 / 清空全部采集数据”按钮，并加入二次确认，便于快速清理历史缓存。
  - 更新 `src/userscript/overlaylex.collector.user.js`：修复误采集脚本/CSS 代码文本（过滤 script/style 等节点及代码特征），并将复制格式改为“按域名分组 + 词条逗号串”（`"A","B","C"`）；新增域名下拉与“复制选定域名”按钮。
  - 新增 `src/packages/obr-www-owlbear-rodeo.json`、`src/packages/obr-clash-battle-system-com.json`、`src/packages/obr-smoke-battle-system-com.json`、`src/packages/obr-outliner-owlbear-rodeo.json`、`src/packages/obr-owlbear-hp-tracker-pages-dev.json`：将 `采集数据.csv` 的 5 个域名词条按域名拆包并批量翻译为中英映射。
  - 更新 `src/userscript/overlaylex.user.js`：新增按包 `target.host/pathPrefix` 的命中判断，只加载当前页面命中的域名包，避免跨域包混载污染翻译结果。
  - 更新 `src/packages/overlaylex-domain-allowlist.json`：扩充插件域名白名单（Battle-System、DDDice、AoE、HP Tracker、GitLab 插件域名），版本升至 `0.2.0`。
  - 更新 `src/worker/src/data.js`：补充 5 个域名翻译包目录元信息，并同步域名准入包版本与回退规则为 `0.2.0`。
