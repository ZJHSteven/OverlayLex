name: release-publish

on:
  push:
    branches:
      - release

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip release]') }}
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      PARATRANZ_TOKEN: ${{ secrets.PARATRANZ_TOKEN }}
      PARATRANZ_PROJECT_ID: ${{ secrets.PARATRANZ_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate Secrets
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "CLOUDFLARE_API_TOKEN is missing."
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "CLOUDFLARE_ACCOUNT_ID is missing."
            exit 1
          fi
          if [ -z "${R2_BUCKET_NAME}" ]; then
            echo "R2_BUCKET_NAME is missing."
            exit 1
          fi
          if [ -z "${PARATRANZ_TOKEN}" ]; then
            echo "PARATRANZ_TOKEN is missing."
            exit 1
          fi
          if [ -z "${PARATRANZ_PROJECT_ID}" ]; then
            echo "PARATRANZ_PROJECT_ID is missing."
            exit 1
          fi

      - name: Resolve Base Ref
        id: base
        shell: bash
        run: |
          BASE_REF="${{ github.event.before }}"
          if [ "$BASE_REF" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE_REF" ]; then
            BASE_REF="$(git rev-parse HEAD~1 2>/dev/null || true)"
          fi
          echo "base_ref=$BASE_REF" >> "$GITHUB_OUTPUT"
          echo "resolved base ref: $BASE_REF"

      - name: Collect Changed Package Files
        id: changed_packages
        shell: bash
        run: |
          mkdir -p .tmp
          CHANGED_FILE=".tmp/release-changed-packages.txt"
          : > "$CHANGED_FILE"

          BASE_REF="${{ steps.base.outputs.base_ref }}"
          if [ -z "$BASE_REF" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "changed_file=$CHANGED_FILE" >> "$GITHUB_OUTPUT"
            echo "No valid base ref, treat as no package changes."
            exit 0
          fi

          mapfile -t CHANGED_FILES < <(git diff --name-only "$BASE_REF...HEAD" -- src/packages | grep -E '\.json$' || true)
          if [ "${#CHANGED_FILES[@]}" -eq 0 ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "changed_file=$CHANGED_FILE" >> "$GITHUB_OUTPUT"
            echo "No changed package files under src/packages."
            exit 0
          fi

          printf '%s\n' "${CHANGED_FILES[@]}" > "$CHANGED_FILE"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "changed_file=$CHANGED_FILE" >> "$GITHUB_OUTPUT"
          echo "changed package files:"
          cat "$CHANGED_FILE"

      - name: Check Paratranz Drift
        if: ${{ steps.changed_packages.outputs.has_changes == 'true' }}
        shell: bash
        run: |
          mapfile -t CHANGED_FILES < "${{ steps.changed_packages.outputs.changed_file }}"
          if [ "${#CHANGED_FILES[@]}" -eq 0 ]; then
            echo "No changed package files, skip drift check."
            exit 0
          fi

          node src/tools/overlaylex-i18n-flow.mjs pull-paratranz \
            --project-id "${PARATRANZ_PROJECT_ID}" \
            --out-dir ".tmp/paratranz-release-check"
          node src/tools/overlaylex-i18n-flow.mjs from-paratranz \
            --input-dir ".tmp/paratranz-release-check"
          if ! git diff --quiet -- "${CHANGED_FILES[@]}"; then
            echo "Paratranz drift detected: local packages are behind remote translations."
            echo "Please merge the latest translation sync PR before releasing changed packages."
            git status --short -- "${CHANGED_FILES[@]}"
            exit 1
          fi

      - name: Skip Drift Message
        if: ${{ steps.changed_packages.outputs.has_changes != 'true' }}
        run: echo "No changed package files, skip Paratranz drift check."

      - name: Verify Release Metadata
        if: ${{ steps.changed_packages.outputs.has_changes == 'true' }}
        run: |
          node src/tools/release-from-staged.mjs verify-release \
            --base-ref "${{ steps.base.outputs.base_ref }}" \
            --api-url "https://overlaylex-demo-api.zhangjiahe0830.workers.dev"

      - name: Skip Verify Message
        if: ${{ steps.changed_packages.outputs.has_changes != 'true' }}
        run: echo "No changed package files, skip release metadata verification."

      - name: Install Worker Dependencies
        if: ${{ steps.changed_packages.outputs.has_changes == 'true' }}
        working-directory: src/worker
        run: npm ci

      - name: Sync Packages To R2
        if: ${{ steps.changed_packages.outputs.has_changes == 'true' }}
        run: |
          node src/tools/sync-r2-packages.mjs \
            --bucket-name "${R2_BUCKET_NAME}" \
            --packages-dir src/packages \
            --worker-dir src/worker \
            --changed-only \
            --base-ref "${{ steps.base.outputs.base_ref }}"

      - name: Skip R2 Sync Message
        if: ${{ steps.changed_packages.outputs.has_changes != 'true' }}
        run: echo "No valid base ref, skip package sync."

      - name: Deploy Worker
        if: ${{ steps.changed_packages.outputs.has_changes == 'true' }}
        working-directory: src/worker
        run: npm run deploy

      - name: Smoke Check Manifest
        if: ${{ steps.changed_packages.outputs.has_changes == 'true' }}
        shell: bash
        run: |
          API_URL="https://overlaylex-demo-api.zhangjiahe0830.workers.dev"
          MANIFEST="$(curl -fsSL "${API_URL}/manifest")"
          echo "${MANIFEST}" > manifest.json
          node - <<'NODE'
          const fs = require("fs");
          const manifest = JSON.parse(fs.readFileSync("manifest.json", "utf8"));
          if (!manifest || !Array.isArray(manifest.packages)) {
            throw new Error("manifest format invalid");
          }
          if (manifest.packages.some((item) => item.id === "obr-room-core")) {
            throw new Error("manifest still contains obr-room-core");
          }
          const dataJs = fs.readFileSync("src/worker/src/data.js", "utf8");
          const match = dataJs.match(/export const SCRIPT_VERSION = "([^"]+)";/);
          if (!match) {
            throw new Error("local script version not found");
          }
          const localVersion = match[1];
          if (manifest.scriptVersion !== localVersion) {
            throw new Error(`scriptVersion mismatch: remote=${manifest.scriptVersion} local=${localVersion}`);
          }
          console.log("manifest smoke check passed.");
          NODE
