# 项目状态快照

## 当前结论（必须最新）
- 现状：发布链路已改为“release 仅同步发包目标文件”，不再使用 `cherry-pick` 全量提交，避免无关文件冲突。
- 已完成：修复 `Check Paratranz Drift`（`obr-www-owlbear-rodeo` 同步远端 38 条差异）；已完成 4 包重发并确认线上版本：`obr-www-owlbear-rodeo=0.2.7`、`bubbles=0.1.4`、`theatre=0.1.4`、`dummysheet=0.1.4`。
- 正在做：收敛发布脚本为“main 真值源 + release 最小同步集（包文件 + worker catalog）”并固化文档。
- 下一步：按新脚本执行一次标准发包演练（仅暂存包文件）并确认全流程无冲突。

## 关键决策与理由（防止“吃书”）
- 决策A：保留“全站触发 + 门禁快速退出”总体架构（原因：兼顾兼容性与性能，不干扰非目标站点）。
- 决策B：把 seeds 内置到用户脚本，仅作为首层快速放行（原因：首次不依赖网络即可判定是否继续，提升冷启动稳定性）。
- 决策C：远端 allowlist 继续作为准入真值源（原因：后端可动态维护域名规则，避免每次改域名都强制用户更新脚本）。
- 决策D：为“后端不可达”增加可视化提示（原因：降低用户误判成本，便于远程协助定位网络可达性问题）。
- 决策E：默认 API 改用自定义域（原因：部分地区/网络对 `workers.dev` 可达性较差，自有域通常更稳定且可控）。
- 决策F：本地 seeds 必须覆盖“已知插件域名集合”（原因：seeds 位于启动最前置门禁，过窄会直接导致 iframe 页面无法进入翻译链路）。
- 决策F：撤销“扩 seeds 覆盖插件域名”的方案，改为“allowlist 缓存判准 + seed 最小兜底”（原因：seeds 语义是首装冷启动入口，不应替代 allowlist）。
- 决策G：allowlist 缓存采用 GM 共享存储作为主存（原因：localStorage 按域隔离，不满足跨域 iframe 场景的缓存复用需求）。
- 决策H：`main -> release` 取消 `cherry-pick`，改为“按文件从 main 提交快照覆盖同步”（原因：release 仅用于触发发包 CI，应只接收本次发包目标文件，避免无关文件冲突与历史噪音）。

## 常见坑 / 复现方法
- 坑1：油猴脚本显示“启用/亮起”不等于翻译流程已生效；脚本可能在域名门禁阶段提前退出。
- 坑2：首次访问目标站点时若后端不可达且本地无缓存，会出现“无悬浮球、无翻译”的静默失败体验。
- 坑3：若页面仅命中全站 `@match` 但未命中本地 seeds，脚本会快速退出；这是预期行为，不是注入异常。
- 坑4：仅用命令行临时加域名而不写入 `wrangler.toml`，后续部署可能出现“配置漂移”；需把域名路由固化到配置文件。
- 坑5：本地 seeds 与 `overlaylex-domain-allowlist` 不一致时，可能出现“远端已放行但本地提前拦截”的假阴性问题。
- 坑5：若无 allowlist 缓存且用户从非 seed 域名直接进入插件页，脚本会按设计快速退出；需先在主站 seed 域名完成首轮冷启动更新。
- 坑6：若用户脚本管理器未授予 `GM_getValue/GM_setValue`，共享缓存会失效并回退为按域 localStorage；需确认脚本头 `@grant` 已生效。
